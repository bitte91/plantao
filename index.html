<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuidashift - Gerenciador de Plantões com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link id="manifest-link" rel="manifest">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 
                            DEFAULT: '#3B82F6', 
                            dark: '#60A5FA',
                            50: '#EFF6FF',
                            100: '#DBEAFE', 
                            500: '#3B82F6',
                            600: '#2563EB',
                            700: '#1D4ED8'
                        },
                        secondary: { 
                            DEFAULT: '#8B5CF6', 
                            dark: '#A78BFA',
                            50: '#F5F3FF',
                            100: '#EDE9FE',
                            500: '#8B5CF6',
                            600: '#7C3AED'
                        },
                        background: { 
                            DEFAULT: '#FAFBFC', 
                            dark: '#0F1419' 
                        },
                        card: { 
                            DEFAULT: '#FFFFFF', 
                            dark: '#1F2937' 
                        },
                        'text-primary': { DEFAULT: '#1F2937', dark: '#F9FAFB' },
                        'text-secondary': { DEFAULT: '#6B7280', dark: '#9CA3AF' },
                        success: '#10B981',
                        pending: '#F59E0B',
                        danger: '#EF4444',
                        border: { DEFAULT: '#E5E7EB', dark: '#374151' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Roboto', 'sans-serif'],
                    },
                    boxShadow: {
                       'custom': '0 4px 12px rgba(0,0,0,0.08)',
                    },
                    keyframes: {
                        'slide-in': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'slide-out': {
                             '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(10px)' },
                        },
                        'spin': {
                            'from': { transform: 'rotate(0deg)' },
                            'to': { transform: 'rotate(360deg)' },
                        },
                        'shimmer': {
                            '0%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' }
                        },
                        'bounce-in': {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '50%': { opacity: '1', transform: 'scale(1.05)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        },
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    },
                    animation: {
                        'slide-in': 'slide-in 0.3s ease-out forwards',
                        'slide-out': 'slide-out 0.3s ease-in forwards',
                        'spin-slow': 'spin 2s linear infinite',
                        'shimmer': 'shimmer 1.5s ease-in-out infinite',
                        'bounce-in': 'bounce-in 0.5s ease-out',
                        'fade-in-up': 'fade-in-up 0.6s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --c-primary: #1976d2; --c-secondary: #29b6f6; --c-background: #f7f9fc;
            --c-card: #ffffff; --c-text-primary: #1a237e; --c-text-secondary: #333333;
            --c-border: #e0e0e0;
        }
        .dark {
            --c-primary: #29b6f6; --c-secondary: #1976d2; --c-background: #121212;
            --c-card: #1e1e1e; --c-text-primary: #f1f1f1; --c-text-secondary: #b3b3b3;
            --c-border: #404040;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--c-background);
            color: var(--c-text-secondary);
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-active { 
            color: var(--c-primary); 
            font-weight: 600;
            background-color: var(--c-primary-light);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .toast-enter { animation: slide-in 0.5s forwards; }
        .toast-exit { animation: slide-out 0.5s forwards; }
        
        .tab-content, .skeleton-loader {
            animation: fade-in-up 0.4s ease-out;
        }

        .calendar-day-dot {
            height: 6px;
            width: 6px;
            border-radius: 50%;
            margin: 1px auto;
        }
        
        /* Estilos modernos adicionais */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
            background-size: 400% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }
        
        .dark .loading-shimmer {
            background: linear-gradient(90deg, #374151 25%, transparent 37%, #374151 63%);
            background-size: 400% 100%;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-effect {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #3B82F6, #8B5CF6, #10B981);
            background-size: 200% 200%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-background text-text-secondary dark:bg-background-dark dark:text-text-secondary-dark">

    <div id="print-area"></div>

    <header class="bg-gradient-to-br from-primary-600 to-primary-700 dark:from-primary-700 dark:to-primary-800 text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                        <span class="text-xl">💙</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">CuidaShift</h1>
                        <p class="text-xs text-white/80">Gerenciador de Plantões</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-2 text-white/90">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                        <span id="current-time" class="text-sm font-medium"></span>
                    </div>
                    <button id="notifications-btn" class="relative p-2 rounded-lg hover:bg-white/10 transition-colors" title="Notificações">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span id="notification-badge" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full text-xs hidden"></span>
                    </button>
                    <button id="theme-toggle-btn" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Alternar tema">
                        <i data-lucide="sun" id="theme-icon-light" class="w-5 h-5"></i>
                        <i data-lucide="moon" id="theme-icon-dark" class="w-5 h-5 hidden"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-md shadow-sm sticky top-0 z-20 no-print border-b border-gray-200/50 dark:border-gray-700/50">
        <div class="container mx-auto">
            <div class="flex items-center justify-center md:justify-start overflow-x-auto scrollbar-hide">
                <button data-tab="dashboard" class="nav-tab tab-active flex items-center gap-2 py-3 px-4 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-dark transition-all duration-200 flex-shrink-0 rounded-t-lg relative">
                    <i data-lucide="home" class="w-4 h-4"></i>
                    <span class="hidden sm:inline font-medium">Dashboard</span>
                </button>
                <button data-tab="shifts" class="nav-tab flex items-center gap-2 py-3 px-4 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-dark transition-all duration-200 flex-shrink-0 rounded-t-lg relative">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span class="hidden sm:inline font-medium">Plantões</span>
                </button>
                <button data-tab="patients" class="nav-tab flex items-center gap-2 py-3 px-4 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-dark transition-all duration-200 flex-shrink-0 rounded-t-lg relative">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span class="hidden sm:inline font-medium">Pacientes</span>
                </button>
                <button data-tab="logbook" class="nav-tab flex items-center gap-2 py-3 px-4 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-dark transition-all duration-200 flex-shrink-0 rounded-t-lg relative">
                    <i data-lucide="book-open" class="w-4 h-4"></i>
                    <span class="hidden sm:inline font-medium">Livro de Bordo</span>
                </button>
                <button data-tab="finances" class="nav-tab flex items-center gap-2 py-3 px-4 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-dark transition-all duration-200 flex-shrink-0 rounded-t-lg relative">
                    <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                    <span class="hidden sm:inline font-medium">Finanças</span>
                </button>
                <button data-tab="reports" class="nav-tab flex items-center gap-2 py-3 px-4 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-dark transition-all duration-200 flex-shrink-0 rounded-t-lg relative">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span class="hidden sm:inline font-medium">Relatórios</span>
                </button>
                <button data-tab="settings" class="nav-tab flex items-center gap-2 py-3 px-4 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-dark transition-all duration-200 flex-shrink-0 rounded-t-lg relative">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span class="hidden sm:inline font-medium">Configurações</span>
                </button>
            </div>
        </div>
    </nav>

    <main id="main-content" class="container mx-auto p-4 md:p-6 no-print pb-20 md:pb-6">
        <!-- O conteúdo será renderizado aqui pelo JS -->
    </main>
    
    <!-- Navegação mobile bottom -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-gray-900/95 backdrop-blur-md border-t border-gray-200/50 dark:border-gray-700/50 md:hidden z-40 no-print">
        <div class="grid grid-cols-5 gap-1 px-2 py-2">
            <button data-tab="dashboard" class="mobile-nav-btn flex flex-col items-center justify-center p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-dark transition-colors">
                <i data-lucide="home" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button data-tab="shifts" class="mobile-nav-btn flex flex-col items-center justify-center p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-dark transition-colors">
                <i data-lucide="calendar" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Plantões</span>
            </button>
            <button data-tab="patients" class="mobile-nav-btn flex flex-col items-center justify-center p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-dark transition-colors">
                <i data-lucide="users" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Pacientes</span>
            </button>
            <button data-tab="finances" class="mobile-nav-btn flex flex-col items-center justify-center p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-dark transition-colors">
                <i data-lucide="dollar-sign" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Finanças</span>
            </button>
            <button data-tab="settings" class="mobile-nav-btn flex flex-col items-center justify-center p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-dark transition-colors">
                <i data-lucide="settings" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Config</span>
            </button>
        </div>
    </div>
    
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

    <button id="fab-add-shift" title="Adicionar Novo Plantão" class="fixed bottom-24 md:bottom-6 right-6 bg-gradient-to-r from-primary to-secondary dark:from-primary-dark dark:to-secondary-dark text-white w-14 h-14 rounded-full shadow-xl hover:shadow-2xl hover:scale-110 transition-all duration-300 flex items-center justify-center no-print z-30 group">
        <i data-lucide="plus" class="w-6 h-6 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let db = { patients: [], shifts: [], logbook: [], settings: { notifications: true, reminderAdvance: 15 } };
            let currentChart = null;
            let currentCalendarDate = new Date();
            let activeReminders = new Map();
            let notificationPermission = false;

            const saveData = () => localStorage.setItem('cuidashiftDB', JSON.stringify(db));
            const loadData = () => {
                const data = localStorage.getItem('cuidashiftDB');
                 if (data && JSON.parse(data).patients && JSON.parse(data).patients.length > 0) {
                    db = JSON.parse(data);
                } else {
                    db = {
                        patients: [
                            { 
                                id: Date.now() + 1, 
                                name: 'Sr. João Silva', 
                                age: 78, 
                                location: 'Centro', 
                                diagnosis: 'Hipertensão', 
                                medications: [{
                                    id: Date.now() + 2, 
                                    name: 'Losartana', 
                                    dosage: '50mg', 
                                    time: '08:00', 
                                    notes: 'Após o café', 
                                    reminderEnabled: true,
                                    lastTaken: null
                                }], 
                                contacts: {
                                    emergency: '+5511999999999',
                                    doctor: '+5511888888888',
                                    family: '+5511777777777'
                                },
                                appointments: [], 
                                logbook: [{
                                    id: Date.now()+3, 
                                    timestamp: new Date().toISOString(), 
                                    note: 'Paciente apresentou quadro estável.',
                                    category: 'observacao',
                                    shiftId: null
                                }] 
                            },
                            { 
                                id: Date.now() + 4, 
                                name: 'Dona Maria Oliveira', 
                                age: 82, 
                                location: 'Vila Nova', 
                                diagnosis: 'Diabetes Tipo 2', 
                                medications: [], 
                                contacts: {
                                    emergency: '',
                                    doctor: '',
                                    family: ''
                                },
                                appointments: [], 
                                logbook: [] 
                            },
                        ],
                        shifts: [
                            { 
                                id: Date.now() + 5, 
                                patientId: Date.now() + 1, 
                                date: '2025-09-15', 
                                startTime: '08:00',
                                endTime: '20:00', 
                                value: 150, 
                                isPaid: true, 
                                paymentDate: '2025-09-16',
                                paymentMethod: 'PIX',
                                description: 'Plantão diurno',
                                recurring: {
                                    enabled: false,
                                    frequency: 'weekly',
                                    endDate: null
                                },
                                checklist: [],
                                logEntries: []
                            },
                            { 
                                id: Date.now() + 6, 
                                patientId: Date.now() + 4, 
                                date: '2025-09-16', 
                                startTime: '20:00',
                                endTime: '08:00', 
                                value: 180, 
                                isPaid: false, 
                                paymentDate: null,
                                paymentMethod: '',
                                description: 'Plantão noturno',
                                recurring: {
                                    enabled: false,
                                    frequency: 'weekly',
                                    endDate: null
                                },
                                checklist: [],
                                logEntries: []
                            },
                        ],
                        logbook: [],
                        settings: {
                            notifications: true,
                            reminderAdvance: 15,
                            theme: 'light',
                            autoBackup: false,
                            financialGoals: {
                                monthlyTarget: 3000
                            }
                        }
                    };
                    saveData();
                }
            };

            const mainContent = document.getElementById('main-content');
            const tabs = document.querySelectorAll('.nav-tab');

            const switchTab = (tabId) => {
                tabs.forEach(tab => tab.classList.toggle('tab-active', tab.dataset.tab === tabId));
                renderSkeletonLoader(mainContent);
                setTimeout(() => renderContent(tabId), 200);
            };

            tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
            
            // Configurar navegação mobile
            const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
            mobileNavBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
            
            // Atualizar relógio em tempo real
            const updateClock = () => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const clockElement = document.getElementById('current-time');
                if (clockElement) {
                    clockElement.textContent = timeStr;
                }
            };
            updateClock();
            setInterval(updateClock, 60000); // Atualizar a cada minuto

            const renderContent = (tabId) => {
                if (!mainContent) return;
                mainContent.innerHTML = '';
                const renderFunctions = {
                    dashboard: renderDashboard, shifts: renderShifts, patients: renderPatients,
                    logbook: renderLogbook, finances: renderFinances, reports: renderReports, settings: renderSettings
                };
                (renderFunctions[tabId] || (() => {}))(mainContent);
                lucide.createIcons();
            };
            
             const renderSkeletonLoader = (element) => {
                 element.innerHTML = `<div class="skeleton-loader space-y-6 animate-fade-in-up">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="h-24 bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 rounded-xl loading-shimmer"></div>
                        <div class="h-24 bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 rounded-xl loading-shimmer"></div>
                        <div class="h-24 bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 rounded-xl loading-shimmer"></div>
                    </div>
                    <div class="space-y-4">
                        <div class="h-8 bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 rounded-lg loading-shimmer w-1/3"></div>
                        <div class="h-64 bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 rounded-xl loading-shimmer"></div>
                    </div>
                </div>`;
            };

            const getEmptyState = (message, icon) => {
                return `<div class="text-center py-20 px-6 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 animate-fade-in-up">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-full flex items-center justify-center">
                        <i data-lucide="${icon}" class="w-8 h-8 text-primary dark:text-primary-dark"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark mb-2">Nenhum item encontrado</h3>
                    <p class="text-sm text-text-secondary dark:text-text-secondary-dark">${message}</p>
                </div>`;
            };
            
            // SISTEMA DE MODAIS
            const openModal = (title, content, actions = []) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop';
                modal.innerHTML = `
                    <div class="bg-card dark:bg-card-dark rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center p-6 border-b border-border dark:border-border-dark">
                            <h2 class="text-xl font-bold text-text-primary dark:text-text-primary-dark">${title}</h2>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6">${content}</div>
                        ${actions.length > 0 ? `<div class="flex justify-end gap-3 p-6 border-t border-border dark:border-border-dark">
                            ${actions.map(action => `<button onclick="${action.action}" class="px-4 py-2 rounded-lg transition-colors ${action.primary ? 'bg-primary dark:bg-primary-dark text-white hover:opacity-90' : action.danger ? 'bg-danger text-white hover:opacity-90' : 'bg-gray-200 dark:bg-gray-700 text-text-secondary dark:text-text-secondary-dark hover:bg-gray-300 dark:hover:bg-gray-600'}">${action.text}</button>`).join('')}
                        </div>` : ''}
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                lucide.createIcons();
            };

            window.closeModal = () => {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = '';
            };
            const requestNotificationPermission = async () => {
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    const permission = await Notification.requestPermission();
                    notificationPermission = permission === 'granted';
                    return notificationPermission;
                }
                return false;
            };

            const scheduleReminder = (medication, patientName) => {
                if (!notificationPermission) return;
                
                const now = new Date();
                const reminderTime = new Date();
                const [hours, minutes] = medication.time.split(':');
                reminderTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                // Se o horário já passou hoje, agendar para amanhã
                if (reminderTime <= now) {
                    reminderTime.setDate(reminderTime.getDate() + 1);
                }
                
                const timeToReminder = reminderTime.getTime() - now.getTime() - (db.settings.reminderAdvance * 60 * 1000);
                
                if (timeToReminder > 0) {
                    const timeoutId = setTimeout(() => {
                        new Notification(`💊 Hora da Medicação`, {
                            body: `${medication.name} ${medication.dosage} para ${patientName}`,
                            icon: '/favicon.ico',
                            badge: '/favicon.ico',
                            tag: `medication-${medication.id}`,
                            requireInteraction: true
                        });
                    }, timeToReminder);
                    
                    activeReminders.set(medication.id, timeoutId);
                }
            };

            const cancelReminder = (medicationId) => {
                if (activeReminders.has(medicationId)) {
                    clearTimeout(activeReminders.get(medicationId));
                    activeReminders.delete(medicationId);
                }
            };

            const updateAllReminders = () => {
                // Cancela todos os lembretes ativos
                activeReminders.forEach(timeoutId => clearTimeout(timeoutId));
                activeReminders.clear();
                
                // Reagenda todos os lembretes habilitados
                db.patients.forEach(patient => {
                    patient.medications?.forEach(medication => {
                        if (medication.reminderEnabled) {
                            scheduleReminder(medication, patient.name);
                        }
                    });
                });
            };

            // SISTEMA DE CALENDÁRIO
            const generateCalendarGrid = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                let grid = '';
                
                // Dias vazios no início
                for (let i = 0; i < firstDay; i++) {
                    grid += '<div class="h-20 md:h-24"></div>';
                }
                
                // Dias do mês
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shiftsOnDay = db.shifts.filter(s => s.date === dateStr);
                    const isToday = dateStr === new Date().toISOString().split('T')[0];
                    
                    grid += `
                        <div class="calendar-day h-20 md:h-24 p-1 border border-border dark:border-border-dark rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors ${isToday ? 'bg-primary/10 border-primary dark:border-primary-dark' : ''}" data-date="${dateStr}">
                            <div class="text-sm font-medium text-text-primary dark:text-text-primary-dark">${day}</div>
                            ${shiftsOnDay.length > 0 ? `<div class="mt-1 space-y-1">${shiftsOnDay.slice(0, 2).map(shift => `<div class="text-xs p-1 rounded bg-primary/20 text-primary dark:bg-primary-dark/20 dark:text-primary-dark truncate">${shift.startTime}</div>`).join('')}${shiftsOnDay.length > 2 ? `<div class="text-xs text-gray-500">+${shiftsOnDay.length - 2}</div>` : ''}</div>` : ''}
                        </div>
                    `;
                }
                
                return grid;
            };

            const renderDayDetails = (selectedDate) => {
                const shiftsOnDay = db.shifts.filter(s => s.date === selectedDate);
                const dayDetailsTitle = document.getElementById('day-details-title');
                const dayDetailsContent = document.getElementById('day-details-content');
                
                if (!dayDetailsTitle || !dayDetailsContent) return;
                
                const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                dayDetailsTitle.textContent = formattedDate;
                
                if (shiftsOnDay.length === 0) {
                    dayDetailsContent.innerHTML = `
                        <p class="text-text-secondary dark:text-text-secondary-dark mb-4">Nenhum plantão agendado para este dia.</p>
                        <button onclick="window.openShiftModal('${selectedDate}')" class="bg-primary dark:bg-primary-dark text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2">
                            <i data-lucide="plus"></i> Agendar Plantão
                        </button>
                    `;
                } else {
                    dayDetailsContent.innerHTML = `
                        <div class="space-y-3 mb-4">
                            ${shiftsOnDay.map(shift => {
                                const patient = db.patients.find(p => p.id === shift.patientId);
                                return `
                                    <div class="p-3 border border-border dark:border-border-dark rounded-lg">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-semibold text-text-primary dark:text-text-primary-dark">${shift.startTime} - ${patient?.name || 'Paciente não encontrado'}</p>
                                                <p class="text-sm text-text-secondary dark:text-text-secondary-dark">${shift.description || 'Sem descrição'}</p>
                                                <p class="text-sm font-medium text-success">${shift.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="window.openShiftModal('${selectedDate}', '${shift.id}')" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary-dark">
                                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="generateShiftReport('${shift.id}')" class="text-gray-500 hover:text-secondary dark:text-gray-400 dark:hover:text-secondary-dark" title="Gerar Relatório">
                                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button onclick="window.openShiftModal('${selectedDate}')" class="bg-primary dark:bg-primary-dark text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2">
                            <i data-lucide="plus"></i> Novo Plantão
                        </button>
                    `;
                }
                
                lucide.createIcons();
            };

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            const renderDashboard = (element) => {
                const totalRevenue = db.shifts.reduce((sum, s) => sum + s.value, 0);
                const totalPaid = db.shifts.filter(s => s.isPaid).reduce((sum, s) => sum + s.value, 0);
                const totalPending = totalRevenue - totalPaid;
                const today = new Date().toISOString().split('T')[0];
                const upcomingShifts = db.shifts.filter(s => s.date >= today).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                const monthlyShifts = db.shifts.filter(s => {
                    const shiftDate = new Date(s.date + 'T00:00:00');
                    return shiftDate.getMonth() === thisMonth && shiftDate.getFullYear() === thisYear;
                });
                const monthlyRevenue = monthlyShifts.reduce((sum, s) => sum + s.value, 0);
                const lastMonthRevenue = 2800; // Simulado para demo
                const revenueGrowth = lastMonthRevenue > 0 ? ((monthlyRevenue - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
                
                element.innerHTML = `
                    <div class="tab-content space-y-6">
                        <!-- Cards de métricas principais -->
                        <div class="grid md:grid-cols-3 gap-6">
                            <!-- Card Receita Total -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 card-hover">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-xl">
                                        <i data-lucide="trending-up" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                                    </div>
                                    <span class="text-sm text-green-600 dark:text-green-400 font-medium">+${revenueGrowth}%</span>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Receita Total</h3>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${totalRevenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                </div>
                            </div>
                            
                            <!-- Card Total Pago -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 card-hover">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-xl">
                                        <i data-lucide="check-circle" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <span class="text-sm text-blue-600 dark:text-blue-400 font-medium">${((totalPaid/totalRevenue)*100).toFixed(0)}%</span>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Total Recebido</h3>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${totalPaid.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                </div>
                            </div>
                            
                            <!-- Card Pendente -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 card-hover">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-xl">
                                        <i data-lucide="clock" class="w-6 h-6 text-yellow-600 dark:text-yellow-400"></i>
                                    </div>
                                    <span class="text-sm text-yellow-600 dark:text-yellow-400 font-medium">${db.shifts.filter(s => !s.isPaid).length}</span>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Valores Pendentes</h3>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${totalPending.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seção de insights -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in-up">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Insights da Semana</h3>
                                <span class="text-xs bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 px-2 py-1 rounded-full font-medium">Novo</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                                <div class="text-center">
                                    <div class="w-12 h-12 bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="trending-up" class="w-6 h-6"></i>
                                    </div>
                                    <p class="text-lg font-bold text-gray-900 dark:text-white">${monthlyShifts.length}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Plantões este mês</p>
                                </div>
                                <div class="text-center">
                                    <div class="w-12 h-12 bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="users" class="w-6 h-6"></i>
                                    </div>
                                    <p class="text-lg font-bold text-gray-900 dark:text-white">${db.patients.length}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Pacientes ativos</p>
                                </div>
                                <div class="text-center">
                                    <div class="w-12 h-12 bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="calendar" class="w-6 h-6"></i>
                                    </div>
                                    <p class="text-lg font-bold text-gray-900 dark:text-white">${upcomingShifts.length}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Próximos plantões</p>
                                </div>
                                <div class="text-center">
                                    <div class="w-12 h-12 bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 rounded-xl flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="activity" class="w-6 h-6"></i>
                                    </div>
                                    <p class="text-lg font-bold text-gray-900 dark:text-white">${monthlyRevenue > 0 ? '+' + revenueGrowth + '%' : '0%'}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Crescimento mensal</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Próximos plantões -->
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden animate-fade-in-up">
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Próximos Plantões</h3>
                                    <button onclick="switchTab('shifts')" class="text-sm text-primary hover:text-primary-600 dark:text-primary-dark font-medium transition-colors">Ver todos</button>
                                </div>
                            </div>
                            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                ${upcomingShifts.length > 0 ? upcomingShifts.map((shift, index) => {
                                    const patient = db.patients.find(p => p.id === shift.patientId);
                                    const shiftDate = new Date(shift.date + 'T00:00:00');
                                    const isToday = shift.date === today;
                                    const isTomorrow = shift.date === new Date(Date.now() + 86400000).toISOString().split('T')[0];
                                    
                                    return `
                                        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer" onclick="window.openShiftModal('${shift.date}', '${shift.id}')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-4">
                                                    <div class="flex-shrink-0">
                                                        <div class="w-12 h-12 rounded-full ${isToday ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : isTomorrow ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400' : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400'} flex items-center justify-center font-semibold text-sm">
                                                            ${shiftDate.getDate()}
                                                        </div>
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2">
                                                            <p class="font-semibold text-gray-900 dark:text-white">${patient?.name || 'Paciente não encontrado'}</p>
                                                            ${isToday ? '<span class="text-xs bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 px-2 py-1 rounded-full font-medium">Hoje</span>' : ''}
                                                            ${isTomorrow ? '<span class="text-xs bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400 px-2 py-1 rounded-full font-medium">Amanhã</span>' : ''}
                                                        </div>
                                                        <div class="flex items-center gap-4 mt-1">
                                                            <p class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1">
                                                                <i data-lucide="clock" class="w-3 h-3"></i>
                                                                ${shift.startTime}${shift.endTime ? ' - ' + shift.endTime : ''}
                                                            </p>
                                                            <p class="text-sm font-medium text-green-600 dark:text-green-400">
                                                                ${shift.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                                            </p>
                                                        </div>
                                                        ${shift.description ? `<p class="text-xs text-gray-500 dark:text-gray-500 mt-1">${shift.description}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="w-2 h-2 rounded-full ${shift.isPaid ? 'bg-green-400' : 'bg-orange-400'}"></span>
                                                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : `
                                    <div class="p-8 text-center">
                                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                                            <i data-lucide="calendar-plus" class="w-8 h-8 text-gray-400"></i>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Nenhum plantão agendado</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Comece criando seu primeiro plantão</p>
                                        <button onclick="window.openShiftModal('${today}')" class="bg-primary hover:bg-primary-600 dark:bg-primary-dark text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                            Criar Plantão
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>`;
            };

            const renderShifts = (element, date = new Date()) => {
                const calendarGridHTML = generateCalendarGrid(date);
                element.innerHTML = `
                    <div class="lg:flex lg:gap-6">
                        <div class="bg-card dark:bg-card-dark p-4 rounded-lg shadow-custom lg:flex-1">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i data-lucide="chevron-left"></i></button>
                                <h2 class="text-xl font-bold text-text-primary dark:text-text-primary-dark">${date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</h2>
                                <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i data-lucide="chevron-right"></i></button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600 dark:text-gray-400">
                                <div class="hidden md:block">Domingo</div><div class="md:hidden">D</div>
                                <div class="hidden md:block">Segunda</div><div class="md:hidden">S</div>
                                <div class="hidden md:block">Terça</div><div class="md:hidden">T</div>
                                <div class="hidden md:block">Quarta</div><div class="md:hidden">Q</div>
                                <div class="hidden md:block">Quinta</div><div class="md:hidden">Q</div>
                                <div class="hidden md:block">Sexta</div><div class="md:hidden">S</div>
                                <div class="hidden md:block">Sábado</div><div class="md:hidden">S</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2">${calendarGridHTML}</div>
                        </div>
                        <div id="day-details" class="lg:w-1/3 mt-6 lg:mt-0">
                           <div class="bg-card dark:bg-card-dark p-4 rounded-lg shadow-custom h-full">
                                <h3 class="font-bold text-lg mb-2" id="day-details-title">Selecione um dia</h3>
                                <div id="day-details-content" class="space-y-2">
                                    <p class="text-text-secondary dark:text-text-secondary-dark">Nenhum dia selecionado.</p>
                                </div>
                           </div>
                        </div>
                    </div>`;

                element.querySelector('#prev-month').addEventListener('click', () => renderShifts(element, new Date(date.setMonth(date.getMonth() - 1))));
                element.querySelector('#next-month').addEventListener('click', () => renderShifts(element, new Date(date.setMonth(date.getMonth() + 1))));
                element.querySelectorAll('.calendar-day').forEach(day => day.addEventListener('click', (e) => {
                    const selectedDate = e.currentTarget.dataset.date;
                    renderDayDetails(selectedDate);
                     element.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('ring-2', 'ring-primary', 'dark:ring-primary-dark'));
                    e.currentTarget.classList.add('ring-2', 'ring-primary', 'dark:ring-primary-dark');
                }));
            };
            
            const renderLogbook = (element) => {
                const allLogEntries = [];
                
                // Combinar entradas do livro de bordo dos pacientes com informações do paciente
                db.patients.forEach(patient => {
                    if (patient.logbook && patient.logbook.length > 0) {
                        patient.logbook.forEach(entry => {
                            allLogEntries.push({
                                ...entry,
                                patientName: patient.name,
                                patientId: patient.id
                            });
                        });
                    }
                });
                
                // Ordenar por data (mais recente primeiro)
                allLogEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                element.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark">Livro de Bordo</h2>
                        <button onclick="openLogbookModal()" class="bg-primary dark:bg-primary-dark text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2">
                            <i data-lucide="plus"></i> Nova Anotação
                        </button>
                    </div>
                    
                    <div class="grid gap-6">
                        ${allLogEntries.length > 0 ? `
                            <div class="bg-card dark:bg-card-dark rounded-lg shadow-custom">
                                <div class="p-4 border-b border-border dark:border-border-dark">
                                    <h3 class="font-semibold text-text-primary dark:text-text-primary-dark">Histórico de Anotações</h3>
                                </div>
                                <div class="divide-y divide-border dark:divide-border-dark">
                                    ${allLogEntries.map(entry => `
                                        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-semibold text-text-primary dark:text-text-primary-dark">${entry.patientName}</span>
                                                    <span class="px-2 py-1 text-xs rounded-full bg-primary/20 text-primary dark:bg-primary-dark/20 dark:text-primary-dark">
                                                        ${entry.category || 'geral'}
                                                    </span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm text-gray-500 dark:text-gray-400">
                                                        ${new Date(entry.timestamp).toLocaleString('pt-BR')}
                                                    </span>
                                                    <button onclick="editLogbookEntry('${entry.id}', '${entry.patientId}')" class="text-gray-400 hover:text-primary dark:hover:text-primary-dark transition-colors">
                                                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="deleteLogbookEntry('${entry.id}', '${entry.patientId}')" class="text-gray-400 hover:text-danger transition-colors">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="text-text-secondary dark:text-text-secondary-dark leading-relaxed">${entry.note}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : getEmptyState("Nenhuma anotação encontrada. Comece criando sua primeira entrada no livro de bordo.", "book-open")}
                    </div>
                `;
            };

            // MODAL DE LIVRO DE BORDO
            window.openLogbookModal = (entryId = null, patientId = null) => {
                const isEdit = !!entryId;
                let entry = null;
                let patient = null;
                
                if (isEdit && patientId) {
                    patient = db.patients.find(p => p.id == patientId);
                    entry = patient?.logbook?.find(e => e.id == entryId);
                }
                
                const title = isEdit ? 'Editar Anotação' : 'Nova Anotação no Livro de Bordo';
                
                const content = `
                    <form id="logbook-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Paciente</label>
                            <select id="logbook-patient" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" required>
                                <option value="">Selecione um paciente</option>
                                ${db.patients.map(p => `<option value="${p.id}" ${patient?.id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Categoria</label>
                            <select id="logbook-category" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark">
                                <option value="observacao" ${entry?.category === 'observacao' ? 'selected' : ''}>Observação</option>
                                <option value="medicacao" ${entry?.category === 'medicacao' ? 'selected' : ''}>Medicação</option>
                                <option value="alimentacao" ${entry?.category === 'alimentacao' ? 'selected' : ''}>Alimentação</option>
                                <option value="higiene" ${entry?.category === 'higiene' ? 'selected' : ''}>Higiene</option>
                                <option value="sintomas" ${entry?.category === 'sintomas' ? 'selected' : ''}>Sintomas</option>
                                <option value="emergencia" ${entry?.category === 'emergencia' ? 'selected' : ''}>Emergência</option>
                                <option value="geral" ${entry?.category === 'geral' ? 'selected' : ''}>Geral</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Anotação</label>
                            <textarea id="logbook-note" rows="6" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" placeholder="Descreva detalhadamente o que aconteceu, observações sobre o estado do paciente, medicações administradas, etc." required>${entry?.note || ''}</textarea>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                            <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2">💡 Dicas para uma boa anotação:</h4>
                            <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                <li>• Seja objetivo e use linguagem clara</li>
                                <li>• Inclua horários específicos quando relevante</li>
                                <li>• Documente mudanças no comportamento ou estado</li>
                                <li>• Registre medicações administradas com dosagem</li>
                            </ul>
                        </div>
                    </form>
                `;
                
                const actions = [
                    { text: 'Cancelar', action: 'closeModal()' },
                    ...(isEdit ? [{ text: 'Excluir', action: `deleteLogbookEntry('${entryId}', '${patientId}')`, danger: true }] : []),
                    { text: isEdit ? 'Salvar' : 'Adicionar', action: `saveLogbookEntry(${isEdit ? `'${entryId}', '${patientId}'` : 'null, null'})`, primary: true }
                ];
                
                openModal(title, content, actions);
            };

            window.saveLogbookEntry = (entryId, patientId) => {
                const selectedPatientId = parseInt(document.getElementById('logbook-patient').value);
                const category = document.getElementById('logbook-category').value;
                const note = document.getElementById('logbook-note').value.trim();
                
                if (!selectedPatientId || !note) {
                    showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                    return;
                }
                
                const patient = db.patients.find(p => p.id === selectedPatientId);
                if (!patient) {
                    showToast('Paciente não encontrado.', 'error');
                    return;
                }
                
                if (!patient.logbook) patient.logbook = [];
                
                const entryData = {
                    id: entryId ? parseInt(entryId) : Date.now(),
                    timestamp: entryId ? (patient.logbook.find(e => e.id == entryId)?.timestamp || new Date().toISOString()) : new Date().toISOString(),
                    note,
                    category,
                    shiftId: null // Pode ser vinculado a um plantão no futuro
                };
                
                if (entryId) {
                    const index = patient.logbook.findIndex(e => e.id == entryId);
                    if (index !== -1) {
                        patient.logbook[index] = entryData;
                        showToast('Anotação atualizada com sucesso!');
                    }
                } else {
                    patient.logbook.push(entryData);
                    showToast('Anotação adicionada ao livro de bordo!');
                }
                
                saveData();
                closeModal();
                
                // Atualizar visualização se estivermos na aba do livro de bordo
                const activeTab = document.querySelector('.nav-tab.tab-active').dataset.tab;
                if (activeTab === 'logbook') {
                    renderLogbook(mainContent);
                }
            };

            window.editLogbookEntry = (entryId, patientId) => {
                openLogbookModal(entryId, patientId);
            };

            window.deleteLogbookEntry = (entryId, patientId) => {
                if (confirm('Tem certeza que deseja excluir esta anotação?')) {
                    const patient = db.patients.find(p => p.id == patientId);
                    if (patient && patient.logbook) {
                        patient.logbook = patient.logbook.filter(e => e.id != entryId);
                        saveData();
                        closeModal();
                        showToast('Anotação excluída com sucesso!');
                        
                        // Atualizar visualização
                        const activeTab = document.querySelector('.nav-tab.tab-active').dataset.tab;
                        if (activeTab === 'logbook') {
                            renderLogbook(mainContent);
                        }
                    }
                }
            };

            const renderPatients = (element) => {
                 element.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark">Lista de Pacientes</h2>
                            <div class="flex items-center gap-4">
                                <div class="relative flex-1 md:flex-none">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                                    </div>
                                    <input type="text" id="patient-search" placeholder="Buscar pacientes..." 
                                           class="w-full md:w-64 pl-10 pr-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                                </div>
                                <button onclick="window.openPatientDetailModal()" class="bg-gradient-to-r from-primary to-secondary dark:from-primary-dark dark:to-secondary-dark text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all duration-200 flex items-center gap-2 font-medium">
                                    <i data-lucide="user-plus" class="w-4 h-4"></i>
                                    <span class="hidden sm:inline">Novo Paciente</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="patient-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${db.patients.length > 0 ? db.patients.map(patient => `
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 cursor-pointer transition-all duration-300 hover:shadow-lg hover:-translate-y-1 card-hover animate-fade-in-up" onclick="window.openPatientDetailModal('${patient.id}')">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-xl flex items-center justify-center">
                                            <i data-lucide="user" class="w-6 h-6 text-primary dark:text-primary-dark"></i>
                                        </div>
                                        <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full font-medium">${patient.age} anos</span>
                                    </div>
                                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-2">${patient.name}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${patient.diagnosis}</p>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
                                            <i data-lucide="map-pin" class="w-3 h-3"></i>
                                            <span>${patient.location || 'Local não informado'}</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            ${patient.medications?.length > 0 ? `<span class="w-2 h-2 bg-green-400 rounded-full" title="Tem medicações"></span>` : ''}
                                            ${patient.logbook?.length > 0 ? `<span class="w-2 h-2 bg-blue-400 rounded-full" title="Tem anotações"></span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('') : getEmptyState("Nenhum paciente cadastrado. Comece adicionando seu primeiro paciente.", "user-plus")}
                        </div>
                    </div>
                `;
                
                // Adicionar funcionalidade de busca
                const searchInput = element.querySelector('#patient-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const patientCards = element.querySelectorAll('#patient-list > div');
                        
                        patientCards.forEach(card => {
                            const patientName = card.querySelector('h3').textContent.toLowerCase();
                            const patientDiagnosis = card.querySelector('p').textContent.toLowerCase();
                            const isVisible = patientName.includes(searchTerm) || patientDiagnosis.includes(searchTerm);
                            
                            card.style.display = isVisible ? 'block' : 'none';
                        });
                    });
                }
                
                lucide.createIcons();
            };

            const renderFinances = (element) => {
                element.innerHTML = `
                    <h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark mb-4">Análise Financeira</h2>
                    <div class="bg-card dark:bg-card-dark p-6 rounded-lg shadow-custom mb-6">
                         <h3 class="text-lg font-semibold mb-4">Faturamento Mensal</h3>
                         <canvas id="financial-chart"></canvas>
                    </div>
                    ${renderFinancesTable()}
                `;
                renderFinancialChart();
            };
            
            const renderFinancesTable = () => {
                const sortedShifts = [...db.shifts].sort((a,b) => new Date(b.date) - new Date(a.date));
                if(sortedShifts.length === 0) return getEmptyState("Nenhum plantão para exibir histórico.", "history");
                return `<div class="bg-card dark:bg-card-dark p-4 rounded-lg shadow-custom"><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-border dark:border-border-dark"><th class="p-2">Data</th><th class="p-2">Paciente</th><th class="p-2">Valor</th><th class="p-2">Status</th><th class="p-2">Ação</th></tr></thead><tbody>${sortedShifts.map(shift => `<tr><td class="p-2">${new Date(shift.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td><td class="p-2">${db.patients.find(p => p.id === shift.patientId)?.name || 'N/A'}</td><td class="p-2">${shift.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td class="p-2"><span class="px-2 py-1 rounded-full text-xs font-semibold ${shift.isPaid ? 'bg-success/20 text-success' : 'bg-pending/20 text-pending'}">${shift.isPaid ? 'Pago' : 'Pendente'}</span></td><td class="p-2"><button onclick="window.togglePayment('${shift.id}')" class="text-sm ${shift.isPaid ? 'text-pending' : 'text-success'} hover:underline">${shift.isPaid ? 'Marcar Pendente' : 'Marcar Pago'}</button></td></tr>`).join('')}</tbody></table></div></div>`;
            }

            const renderReports = (element) => {
                element.innerHTML = `<h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark mb-4">Exportação e Relatórios</h2><div class="bg-card dark:bg-card-dark p-6 rounded-lg shadow-custom space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button id="print-financial-report-btn" class="bg-primary dark:bg-primary-dark text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"><i data-lucide="printer"></i>Imprimir Relatório Financeiro</button><button id="export-shifts-csv-btn" class="bg-success text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"><i data-lucide="file-spreadsheet"></i>Exportar Plantões (CSV)</button><button id="export-patients-csv-btn" class="bg-secondary dark:bg-secondary-dark text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"><i data-lucide="file-spreadsheet"></i>Exportar Pacientes (CSV)</button></div></div>`;
                element.querySelector('#print-financial-report-btn').addEventListener('click', printFinancialReport);
                element.querySelector('#export-shifts-csv-btn').addEventListener('click', () => exportToCsv('shifts'));
                element.querySelector('#export-patients-csv-btn').addEventListener('click', () => exportToCsv('patients'));
            };

            const renderSettings = (element) => {
                 element.innerHTML = `<h2 class="text-2xl font-bold text-text-primary dark:text-text-primary-dark mb-4">Configurações de Dados</h2><div class="grid md:grid-cols-2 gap-6"><div class="bg-card dark:bg-card-dark p-6 rounded-lg shadow-custom space-y-4"><h3 class="font-semibold text-lg text-text-primary dark:text-text-primary-dark">Exportar Dados</h3><p>Faça o backup de todos os seus dados em um arquivo JSON.</p><button id="export-data-btn" class="bg-success text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"><i data-lucide="download"></i>Exportar para JSON</button></div><div class="bg-card dark:bg-card-dark p-6 rounded-lg shadow-custom space-y-4"><h3 class="font-semibold text-lg text-text-primary dark:text-text-primary-dark">Importar Dados</h3><p>Importe dados de um arquivo JSON. Isso substituirá todos os dados existentes.</p><input type="file" id="import-file-input" class="hidden" accept=".json"><button onclick="document.getElementById('import-file-input').click()" class="bg-pending text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"><i data-lucide="upload"></i>Importar de JSON</button></div><div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-500/30 p-6 rounded-lg shadow-custom space-y-4 md:col-span-2"><h3 class="font-semibold text-lg text-danger">Área de Risco</h3><p>Cuidado: esta ação é irreversível e apagará todos os seus dados.</p><button id="clear-data-btn" class="bg-danger text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"><i data-lucide="trash-2"></i>Apagar Todos os Dados</button></div></div>`;
                 element.querySelector('#export-data-btn').addEventListener('click', exportData);
                 element.querySelector('#import-file-input').addEventListener('change', importData);
                 element.querySelector('#clear-data-btn').addEventListener('click', clearData);
            };

            const setupTheme = () => {
                const themeToggleBtn = document.getElementById('theme-toggle-btn');
                const lightIcon = document.getElementById('theme-icon-light');
                const darkIcon = document.getElementById('theme-icon-dark');
                const htmlEl = document.documentElement;

                const applyTheme = (theme) => {
                    if (theme === 'dark') {
                        htmlEl.classList.add('dark');
                        lightIcon.classList.add('hidden');
                        darkIcon.classList.remove('hidden');
                    } else {
                        htmlEl.classList.remove('dark');
                        darkIcon.classList.add('hidden');
                        lightIcon.classList.remove('hidden');
                    }
                    localStorage.setItem('theme', theme);
                    const financesTab = document.getElementById('finances');
                    if(financesTab && financesTab.style.display !== 'none' && currentChart){
                         setTimeout(() => renderFinancialChart(), 50);
                    }
                    lucide.createIcons();
                };

                const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(currentTheme);

                themeToggleBtn.addEventListener('click', () => {
                    const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
                    applyTheme(newTheme);
                });
            };

            const setupServiceWorker = () => { /* Implementação completa aqui... */ };
            const showToast = (message, type = 'success') => {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                const icons = {
                    success: 'check-circle',
                    error: 'x-circle',
                    warning: 'alert-triangle',
                    info: 'info'
                };
                
                const colors = {
                    success: 'bg-white dark:bg-gray-800 border-l-4 border-green-500 text-gray-900 dark:text-white shadow-lg',
                    error: 'bg-white dark:bg-gray-800 border-l-4 border-red-500 text-gray-900 dark:text-white shadow-lg',
                    warning: 'bg-white dark:bg-gray-800 border-l-4 border-yellow-500 text-gray-900 dark:text-white shadow-lg',
                    info: 'bg-white dark:bg-gray-800 border-l-4 border-blue-500 text-gray-900 dark:text-white shadow-lg'
                };
                
                const iconColors = {
                    success: 'text-green-500',
                    error: 'text-red-500',
                    warning: 'text-yellow-500',
                    info: 'text-blue-500'
                };
                
                toast.className = `p-4 rounded-lg mb-3 toast-enter ${colors[type]} backdrop-blur-md border border-gray-200 dark:border-gray-700 max-w-sm`;
                toast.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <i data-lucide="${icons[type]}" class="w-5 h-5 ${iconColors[type]}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                lucide.createIcons();
                
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.remove('toast-enter');
                        toast.classList.add('toast-exit');
                        toast.addEventListener('animationend', () => {
                            if (toast.parentElement) {
                                toast.remove();
                            }
                        });
                    }
                }, 3000);
            };

            // FUNCIONALIDADES DE PAGAMENTO
            window.togglePayment = (shiftId) => {
                const shift = db.shifts.find(s => s.id == shiftId);
                if (!shift) {
                    showToast('Plantão não encontrado.', 'error');
                    return;
                }
                
                shift.isPaid = !shift.isPaid;
                shift.paymentDate = shift.isPaid ? new Date().toISOString().split('T')[0] : null;
                
                saveData();
                showToast(`Plantão marcado como ${shift.isPaid ? 'pago' : 'pendente'}!`);
                
                // Atualizar visualização
                const activeTab = document.querySelector('.nav-tab.tab-active').dataset.tab;
                if (activeTab === 'finances') {
                    renderFinances(mainContent);
                } else {
                    renderContent(activeTab);
                }
            };

            // MODAIS DE PACIENTE
            window.openPatientDetailModal = (patientId) => {
                const isEdit = !!patientId;
                const patient = isEdit ? db.patients.find(p => p.id == patientId) : null;
                const title = isEdit ? `Detalhes de ${patient.name}` : 'Novo Paciente';
                
                const content = `
                    <div class="space-y-6">
                        <form id="patient-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Nome Completo *</label>
                                    <input type="text" id="patient-name" value="${patient?.name || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Idade *</label>
                                    <input type="number" id="patient-age" value="${patient?.age || ''}" min="0" max="120" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Localização</label>
                                <input type="text" id="patient-location" value="${patient?.location || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" placeholder="Bairro, cidade...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Diagnóstico *</label>
                                <textarea id="patient-diagnosis" rows="2" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" required>${patient?.diagnosis || ''}</textarea>
                            </div>
                        </form>
                        
                        ${isEdit ? `
                            <div class="border-t border-border dark:border-border-dark pt-6">
                                <h4 class="font-semibold text-text-primary dark:text-text-primary-dark mb-4">Contatos de Emergência</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Emergência</label>
                                        <input type="tel" id="contact-emergency" value="${patient?.contacts?.emergency || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" placeholder="+55 11 99999-9999">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Médico</label>
                                        <input type="tel" id="contact-doctor" value="${patient?.contacts?.doctor || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" placeholder="+55 11 88888-8888">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Família</label>
                                        <input type="tel" id="contact-family" value="${patient?.contacts?.family || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark text-text-secondary dark:text-text-secondary-dark" placeholder="+55 11 77777-7777">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border-t border-border dark:border-border-dark pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-semibold text-text-primary dark:text-text-primary-dark">Medicações</h4>
                                    <button onclick="addMedication('${patient.id}')" class="bg-secondary dark:bg-secondary-dark text-white px-3 py-1 rounded text-sm hover:opacity-90 transition-opacity flex items-center gap-1">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
                                    </button>
                                </div>
                                <div id="medications-list" class="space-y-3">
                                    ${patient?.medications?.map(med => `
                                        <div class="p-3 border border-border dark:border-border-dark rounded-lg">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <p class="font-medium text-text-primary dark:text-text-primary-dark">${med.name} - ${med.dosage}</p>
                                                    <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Horário: ${med.time}</p>
                                                    ${med.notes ? `<p class="text-sm text-gray-500">${med.notes}</p>` : ''}
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <label class="flex items-center gap-1 text-sm">
                                                        <input type="checkbox" ${med.reminderEnabled ? 'checked' : ''} onchange="toggleMedicationReminder('${patient.id}', '${med.id}')" class="rounded">
                                                        Lembrete
                                                    </label>
                                                    <button onclick="editMedication('${patient.id}', '${med.id}')" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary-dark">
                                                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="removeMedication('${patient.id}', '${med.id}')" class="text-gray-500 hover:text-danger dark:text-gray-400">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') || '<p class="text-gray-500 text-center py-4">Nenhuma medicação cadastrada</p>'}
                                </div>
                            </div>
                            
                            <div class="border-t border-border dark:border-border-dark pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-semibold text-text-primary dark:text-text-primary-dark">Histórico Recente</h4>
                                    <button onclick="openLogbookModal(null, '${patient.id}')" class="bg-primary dark:bg-primary-dark text-white px-3 py-1 rounded text-sm hover:opacity-90 transition-opacity flex items-center gap-1">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Nova Anotação
                                    </button>
                                </div>
                                <div class="max-h-60 overflow-y-auto space-y-2">
                                    ${patient?.logbook?.slice(-5).reverse().map(entry => `
                                        <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="text-xs text-gray-500">${new Date(entry.timestamp).toLocaleString('pt-BR')}</span>
                                                <span class="text-xs px-2 py-1 rounded-full bg-primary/20 text-primary dark:bg-primary-dark/20 dark:text-primary-dark">${entry.category || 'geral'}</span>
                                            </div>
                                            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">${entry.note}</p>
                                        </div>
                                    `).join('') || '<p class="text-gray-500 text-center py-4">Nenhuma anotação encontrada</p>'}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                const actions = [
                    { text: 'Cancelar', action: 'closeModal()' },
                    ...(isEdit ? [{ text: 'Excluir Paciente', action: `deletePatient('${patientId}')`, danger: true }] : []),
                    { text: isEdit ? 'Salvar Alterações' : 'Criar Paciente', action: `savePatient(${isEdit ? `'${patientId}'` : 'null'})`, primary: true }
                ];
                
                openModal(title, content, actions);
            };

            // MODAIS DE PLANTÃO
            window.openShiftModal = (date, shiftId) => {
                const isEdit = !!shiftId;
                const shift = isEdit ? db.shifts.find(s => s.id == shiftId) : null;
                const title = isEdit ? 'Editar Plantão' : 'Novo Plantão';

                const content = `
                    <form id="shift-form" class="space-y-4">
                        <input type="hidden" id="shift-id" value="${shift?.id || ''}">
                        <div>
                            <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Paciente *</label>
                            <select id="shift-patient" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark" required>
                                ${db.patients.map(p => `<option value="${p.id}" ${shift?.patientId == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Data *</label>
                                <input type="date" id="shift-date" value="${shift?.date || date}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Valor (R$) *</label>
                                <input type="number" id="shift-value" value="${shift?.value || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Horário de Início *</label>
                                <input type="time" id="shift-startTime" value="${shift?.startTime || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Horário de Fim</label>
                                <input type="time" id="shift-endTime" value="${shift?.endTime || ''}" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary dark:text-text-primary-dark mb-2">Descrição</label>
                            <textarea id="shift-description" rows="3" class="w-full p-3 border border-border dark:border-border-dark rounded-lg bg-card dark:bg-card-dark">${shift?.description || ''}</textarea>
                        </div>
                         <div class="flex items-center">
                            <input type="checkbox" id="shift-isPaid" ${shift?.isPaid ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                            <label for="shift-isPaid" class="ml-2 block text-sm text-text-primary dark:text-text-primary-dark">Plantão já foi pago?</label>
                        </div>
                    </form>
                `;

                const actions = [
                    { text: 'Cancelar', action: 'closeModal()' },
                    ...(isEdit ? [{ text: 'Excluir', action: `deleteShift('${shiftId}')`, danger: true }] : []),
                    { text: isEdit ? 'Salvar Alterações' : 'Adicionar Plantão', action: `saveShift(${isEdit ? `'${shiftId}'` : 'null'})`, primary: true }
                ];

                openModal(title, content, actions);
            };

            window.saveShift = (shiftId) => {
                const isEdit = !!shiftId;
                const patientId = parseInt(document.getElementById('shift-patient').value);
                const date = document.getElementById('shift-date').value;
                const value = parseFloat(document.getElementById('shift-value').value);
                const startTime = document.getElementById('shift-startTime').value;
                const endTime = document.getElementById('shift-endTime').value;
                const description = document.getElementById('shift-description').value;
                const isPaid = document.getElementById('shift-isPaid').checked;

                if (!patientId || !date || !value || !startTime) {
                    showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                    return;
                }

                const shiftData = {
                    id: isEdit ? parseInt(shiftId) : Date.now(),
                    patientId,
                    date,
                    startTime,
                    endTime,
                    value,
                    isPaid,
                    paymentDate: isPaid ? (isEdit && db.shifts.find(s=>s.id == shiftId) ? db.shifts.find(s=>s.id == shiftId).paymentDate : new Date().toISOString().split('T')[0]) : null,
                    description,
                    recurring: { enabled: false },
                    checklist: [],
                    logEntries: []
                };

                if (isEdit) {
                    const index = db.shifts.findIndex(s => s.id == shiftId);
                    db.shifts[index] = shiftData;
                    showToast('Plantão atualizado com sucesso!');
                } else {
                    db.shifts.push(shiftData);
                    showToast('Plantão adicionado com sucesso!');
                }

                saveData();
                closeModal();
                renderContent(document.querySelector('.nav-tab.tab-active').dataset.tab);
            };

            window.deleteShift = (shiftId) => {
                if (confirm('Tem certeza que deseja excluir este plantão?')) {
                    db.shifts = db.shifts.filter(s => s.id != shiftId);
                    saveData();
                    closeModal();
                    showToast('Plantão excluído com sucesso!');
                    renderContent(document.querySelector('.nav-tab.tab-active').dataset.tab);
                }
            };

            window.savePatient = (patientId) => {
                const isEdit = !!patientId;
                const name = document.getElementById('patient-name').value;
                const age = document.getElementById('patient-age').value;
                const location = document.getElementById('patient-location').value;
                const diagnosis = document.getElementById('patient-diagnosis').value;

                if (!name || !age || !diagnosis) {
                    showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                    return;
                }

                if (isEdit) {
                    const patient = db.patients.find(p => p.id == patientId);
                    if (patient) {
                        patient.name = name;
                        patient.age = age;
                        patient.location = location;
                        patient.diagnosis = diagnosis;
                        patient.contacts.emergency = document.getElementById('contact-emergency').value;
                        patient.contacts.doctor = document.getElementById('contact-doctor').value;
                        patient.contacts.family = document.getElementById('contact-family').value;
                        showToast('Paciente atualizado com sucesso!');
                    }
                } else {
                    const newPatient = {
                        id: Date.now(),
                        name,
                        age,
                        location,
                        diagnosis,
                        medications: [],
                        contacts: { emergency: '', doctor: '', family: '' },
                        appointments: [],
                        logbook: []
                    };
                    db.patients.push(newPatient);
                    showToast('Paciente adicionado com sucesso!');
                }

                saveData();
                closeModal();
                renderContent('patients');
            };

            window.deletePatient = (patientId) => {
                if (confirm('Tem certeza que deseja excluir este paciente? Esta ação também removerá todos os plantões associados a ele.')) {
                    db.patients = db.patients.filter(p => p.id != patientId);
                    db.shifts = db.shifts.filter(s => s.patientId != patientId);
                    saveData();
                    closeModal();
                    showToast('Paciente excluído com sucesso!');
                    renderContent('patients');
                }
            };

            // --- INICIALIZAÇÃO GERAL ---
            loadData();
            setupTheme();
            setupServiceWorker();
            switchTab('dashboard');
            
            document.getElementById('fab-add-shift').addEventListener('click', () => {
                window.openShiftModal(new Date().toISOString().split('T')[0]);
            });
        });
    </script>
</body>
</html>

